{"componentChunkName":"component---src-templates-post-jsx","path":"/docker-deploy/","result":{"data":{"site":{"siteMetadata":{"title":"hyungkishin.blog"}},"markdownRemark":{"id":"374806d1-d43a-5f19-98e2-0d71c8cf7750","excerpt":"ğŸ“ Next.js + Docker + ECR + CloudFront ì‹¤ì „ ë°°í¬ ìë™í™” ë°°ê²½ íšŒì‚¬ëŠ” ì–¸ë¡ ì‚¬(ë¯¸ë””ì–´)ë¼ AMP ì§€ì› í•„ìˆ˜ ì˜€ë‹¤. ê²€ìƒ‰ì—”ì§„ ìµœì í™”(SEO)ì™€ íŠ¸ë˜í”½ ìµœì í™”ê°€ í•„ìš”í•˜ê²Œ ë˜ì–´ì„œ ë°°í¬ ì§„í–‰ì¤‘ ê°‘ìê¸° ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤. App Router + Pages Router í˜¼ìš© í”„ë¡œì íŠ¸ Docker + ECR + EC2 ì„œë²„ê¸°ë°˜ ì„œë¹„ìŠ¤ ìš´ì˜ Câ€¦","html":"<h1>ğŸ“ Next.js + Docker + ECR + CloudFront ì‹¤ì „ ë°°í¬ ìë™í™”</h1>\n<h2>ë°°ê²½</h2>\n<p>íšŒì‚¬ëŠ” ì–¸ë¡ ì‚¬(ë¯¸ë””ì–´)ë¼ AMP ì§€ì› í•„ìˆ˜ ì˜€ë‹¤.</p>\n<p>ê²€ìƒ‰ì—”ì§„ ìµœì í™”(SEO)ì™€ íŠ¸ë˜í”½ ìµœì í™”ê°€ í•„ìš”í•˜ê²Œ ë˜ì–´ì„œ ë°°í¬ ì§„í–‰ì¤‘ ê°‘ìê¸° ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤.</p>\n<p>App Router + Pages Router í˜¼ìš© í”„ë¡œì íŠ¸</p>\n<p>Docker + ECR + EC2 ì„œë²„ê¸°ë°˜ ì„œë¹„ìŠ¤ ìš´ì˜</p>\n<p>CDNì€ AWS CloudFront ì‚¬ìš© ì¤‘</p>\n<h2>ë¬¸ì œ ìƒí™© ë°œìƒ</h2>\n<p>ê¸°ì¡´ ìˆ˜ë™ Docker Build + Push + ì„œë²„ ì¬ë°°í¬ ê³¼ì • ë³µì¡</p>\n<p>ì„œë²„ Docker OverlayFS ìŠ¤í† ë¦¬ì§€ ë“œë¼ì´ë²„ ê³¼ë¶€í•˜ë¡œ í„°ì§</p>\n<p>ì—ëŸ¬: \"error creating overlay mount... no such file or directory\"</p>\n<p>ë””ìŠ¤í¬ I/O ë³‘ëª© ë°œìƒ â†’ ìºì‹œ ë ˆì´ì–´ ë¹„ì •ìƒí™”</p>\n<p>ë¹Œë“œ ì¤‘ ì¤‘ê°„ ë ˆì´ì–´ê°€ ê¹¨ì ¸ì„œ docker-compose up ì‹¤íŒ¨</p>\n<p>CDN ìºì‹œ í¼ì§€(purge)ë„ ìˆ˜ë™ì´ë¼</p>\n<p>êµ¬ë²„ì „ CSS + ì‹ ë²„ì „ HTML ì„ì—¬ ë¡œë”© â†’ ìŠ¤íƒ€ì¼ ê¹¨ì§ \"\"\"</p>\n<ol start=\"3\">\n<li>í•´ê²° ëª©í‘œ\n\"\"\"text</li>\n</ol>\n<p>Dockerfile êµ¬ì¡° ìµœì í™” (ë©€í‹° ìŠ¤í…Œì´ì§€ + í¼ë¯¸ì…˜ ì˜¤ë¥˜ ì œê±°)</p>\n<p>ë°°í¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (Build â†’ Push â†’ ì„œë²„ ì—…ë°ì´íŠ¸)</p>\n<p>CloudFront ìºì‹œ í¼ì§€ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±</p>\n<p>Slack ë°°í¬ ê²°ê³¼ ì•Œë¦¼</p>\n<p>Docker OverlayFS ì¥ì•  ëŒ€ë¹„ (í•­ìƒ clean build) \"\"\"</p>\n<h2>Dockerfile</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1. ê¸°ë³¸ ë² ì´ìŠ¤ ì´ë¯¸ì§€\nFROM node:20.19.0-alpine AS base\n\nARG NEXT_PUBLIC_ENV ARG NODE_ENV\n\nRUN apk --no-cache add tzdata &amp;&amp;\ncp /usr/share/zoneinfo/Asia/Seoul /etc/localtime &amp;&amp;\necho \"Asia/Seoul\" > /etc/timezone\n\n2. ì˜ì¡´ì„± ì„¤ì¹˜\nFROM base AS deps WORKDIR /app COPY package.json pnpm-lock.yaml ./ RUN corepack enable &amp;&amp; corepack prepare pnpm@10.9.0 --activate &amp;&amp; pnpm install --frozen-lockfile\n\n3. ì•± ë¹Œë“œ\nFROM base AS builder WORKDIR /app COPY --from=deps /app/node_modules ./node_modules COPY . . RUN corepack enable &amp;&amp; corepack prepare pnpm@10.9.0 --activate\n\nENV NODE_ENV=production ENV NEXT_TELEMETRY_DISABLED=1 ENV CSS_MODULES_HASH_PREFIX=stable_ ENV OUTPUT=standalone\n\nARG NEXT_PUBLIC_ENV RUN if [ \"$NEXT_PUBLIC_ENV\" = \"production\" ]; then\ncp ./env/.env.production .env.production;\nelif [ \"$NEXT_PUBLIC_ENV\" = \"staging\" ]; then\ncp ./env/.env.staging .env.production;\nelif [ \"$NEXT_PUBLIC_ENV\" = \"development\" ]; then\ncp ./env/.env.development .env.production;\nelse\ncp ./env/.env.test .env.production;\nfi\n\nRUN pnpm run build</code></pre></div>\n<h2>ëŸ°íƒ€ì„</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM base AS runner WORKDIR /app\n\nRUN npm install -g pm2 RUN addgroup --system --gid 1001 nodejs &amp;&amp; adduser --system --uid 1001 nextjs\n\nCOPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./ COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static COPY --from=builder --chown=nextjs:nodejs /app/public ./public COPY --from=builder --chown=nextjs:nodejs /app/public/fonts ./public/fonts COPY --from=builder --chown=nextjs:nodejs /app/.next/server/pages/amp ./.next/server/pages/amp\n\nRUN mkdir -p .next/static/media &amp;&amp; chown -R nextjs:nodejs .next\n\nUSER nextjs\n\nEXPOSE 3000 ENV PORT=3000 ENV HOSTNAME=\"0.0.0.0\"\n\nCMD [\"pm2-runtime\", \"start\", \"server.js\", \"-i\", \"2\", \"--max-memory-restart\", \"1536M\"] \"\"\"</code></pre></div>\n<h2>ë°°í¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ (deploy.sh)</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#!/bin/bash\n\nset -e\n\nAWS_PROFILE=default AWS_REGION=ap-northeast-2 AWS_ECR_REPOSITORY=537124952818.dkr.ecr.ap-northeast-2.amazonaws.com/kthome-prd-frontend-ecr CLOUDFRONT_DISTRIBUTION_ID=YOUR_CLOUDFRONT_ID SLACK_WEBHOOK_URL=YOUR_SLACK_WEBHOOK_URL NEXT_PUBLIC_ENV=production SERVER_IP=YOUR_SERVER_IP DOCKER_COMPOSE_DIR=/home/ubuntu/deploy-folder\n\nGIT_COMMIT_HASH=$(git rev-parse --short HEAD) IMAGE_TAG=$GIT_COMMIT_HASH\n\necho \"ğŸš€ ë°°í¬ ì‹œì‘ (íƒœê·¸: $IMAGE_TAG)\"\n\ndocker build --build-arg NEXT_PUBLIC_ENV=$NEXT_PUBLIC_ENV -t $AWS_ECR_REPOSITORY:$IMAGE_TAG . aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ECR_REPOSITORY docker push $AWS_ECR_REPOSITORY:$IMAGE_TAG\n\nssh ubuntu@$SERVER_IP &lt;&lt; EOF cd $DOCKER_COMPOSE_DIR sed -i \"s|image: .*|image: $AWS_ECR_REPOSITORY:$IMAGE_TAG|\" docker-compose.yml docker-compose pull docker-compose up -d --remove-orphans EOF\n\naws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths\n\"/_next/data/\" \"/_next/static/\" \"/favicon.ico\" \"/robots.txt\" \"/sitemap.xml\" \"/index.html\"\n\ncurl -X POST -H 'Content-type: application/json' --data \"{ \"text\": \"âœ… ë°°í¬ ì™„ë£Œ: $IMAGE_TAG\", \"attachments\": [ { \"color\": \"#36a64f\", \"fields\": [ { \"title\": \"ë°°í¬ ì„œë²„\", \"value\": \"$SERVER_IP\", \"short\": true }, { \"title\": \"íƒœê·¸\", \"value\": \"$IMAGE_TAG\", \"short\": true } ] } ] }\" $SLACK_WEBHOOK_URL\n\necho \"âœ… ì „ì²´ ë°°í¬ ì™„ë£Œ!\"</code></pre></div>\n<h2>Docker OverlayFS ì´ìŠˆ ëŒ€ì‘ ë°©ë²•</h2>\n<p>Docker Build ì‹œ --no-cache ì˜µì…˜ ì‚¬ìš© ìŠµê´€í™”</p>\n<p>ì˜¤ë˜ëœ dangling ì´ë¯¸ì§€ ì£¼ê¸°ì  ì œê±° (ex: docker system prune -af)</p>\n<p>ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡± ëŒ€ë¹„ â†’ EBS í™•ì¥ ì •ì±… ì¤€ë¹„</p>\n<p>ëŒ€ê·œëª¨ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œ layer ìˆ˜ ì¤„ì´ê¸° \"\"\"</p>\n<h2>ìµœì¢… ì •ë¦¬</h2>\n<p>ë°°í¬ ìë™í™” ì„±ê³µ</p>\n<p>ì„œë²„ ê¹¨ì§(overlay2 ë””ìŠ¤í¬ ì—ëŸ¬) ë³µêµ¬</p>\n<p>AMP SEO + ì¼ë°˜ SEO ëŒ€ì‘ ì™„ë¹„</p>\n<p>Slack ì‹¤ì‹œê°„ ë°°í¬ ì•Œë¦¼ ì—°ë™</p>\n<p>ECR + EC2 + CloudFront ìºì‹œ í¼ì§€ ìë™í™” ì™„ë£Œ</p>","frontmatter":{"title":"AMP","date":"April 17, 2025","update":"April 17, 2024","tags":["front-end"],"series":null},"fields":{"slug":"/docker-deploy/","readingTime":{"minutes":2.81}}},"seriesList":{"edges":[{"node":{"id":"4cc639f4-37bf-5401-b7b8-4c5d3e23c5b6","fields":{"slug":"/deploy-strategy/"},"frontmatter":{"title":"ë°°í¬ì „ëµ"}}},{"node":{"id":"00662a55-abc5-525f-a35e-90e2a4567225","fields":{"slug":"/kotlin/"},"frontmatter":{"title":"ì½”í‹€ë¦°ì˜ í˜„ì¬ì™€ ë¯¸ë˜"}}},{"node":{"id":"49cee026-4707-58a8-9c2e-b2ee65c4f1c3","fields":{"slug":"/cpu-bound-vs-io-bound/"},"frontmatter":{"title":"CPU Bound ì™€ IO Bound"}}},{"node":{"id":"7d6614c0-6b90-566a-8a4e-8e4be0749cc9","fields":{"slug":"/basic/"},"frontmatter":{"title":"Redis"}}},{"node":{"id":"edee6afa-bced-5993-86ff-512b48f22028","fields":{"slug":"/rag/"},"frontmatter":{"title":"Rag"}}},{"node":{"id":"4fdc4c80-b3ef-568f-98a9-6d6f7d14f737","fields":{"slug":"/spring-ai/"},"frontmatter":{"title":"Ai. Spring AI ë¡œ ë•Œì›Œë„ ë˜ë‚˜ìœ ? 1í¸"}}},{"node":{"id":"374806d1-d43a-5f19-98e2-0d71c8cf7750","fields":{"slug":"/docker-deploy/"},"frontmatter":{"title":"AMP"}}},{"node":{"id":"cb547d96-bb64-5e7e-86d7-b52051bfd56d","fields":{"slug":"/phase1/"},"frontmatter":{"title":"ğŸ—ï¸ í•œ ë‹¬ê°„ì˜ ë‰´ìŠ¤ ì‚¬ì´íŠ¸ í”„ë¡ íŠ¸ ì„±ëŠ¥ ìµœì í™”âœ¨"}}},{"node":{"id":"b647b419-d924-52b4-99f0-91273c90cdeb","fields":{"slug":"/phase2/"},"frontmatter":{"title":"ğŸ—ï¸ AMP í˜ì´ì§€ ê°œë°œ"}}},{"node":{"id":"f46e0796-437c-53a2-a1fb-c1149035de8e","fields":{"slug":"/phase4/"},"frontmatter":{"title":"í¼í¬ë¨¼ìŠ¤ ìµœì í™” ë¥¼ í–¥í•´ - 2ë¶€"}}},{"node":{"id":"31e4baea-f4e0-533c-a42f-1f728622fbad","fields":{"slug":"/phase3/"},"frontmatter":{"title":"í¼í¬ë¨¼ìŠ¤ ìµœì í™” ë¥¼ í–¥í•´ - 1ë¶€"}}}]},"previous":{"fields":{"slug":"/spring-ai/"},"frontmatter":{"title":"Ai. Spring AI ë¡œ ë•Œì›Œë„ ë˜ë‚˜ìœ ? 1í¸"}},"next":{"fields":{"slug":"/phase1/"},"frontmatter":{"title":"ğŸ—ï¸ í•œ ë‹¬ê°„ì˜ ë‰´ìŠ¤ ì‚¬ì´íŠ¸ í”„ë¡ íŠ¸ ì„±ëŠ¥ ìµœì í™”âœ¨"}}},"pageContext":{"id":"374806d1-d43a-5f19-98e2-0d71c8cf7750","series":null,"previousPostId":"4fdc4c80-b3ef-568f-98a9-6d6f7d14f737","nextPostId":"cb547d96-bb64-5e7e-86d7-b52051bfd56d"}},"staticQueryHashes":[],"slicesMap":{}}